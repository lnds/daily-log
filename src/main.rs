use daily_log::app::App;
use daily_log::cli::{Cli, Commands};
use daily_log::commands;
use clap::Parser;

fn main() -> color_eyre::Result<()> {
    color_eyre::install()?;

    let cli = Cli::parse();

    match cli.command {
        Some(Commands::Now { 
            entry, 
            note, 
            back, 
            section, 
            finish_last, 
            from, 
            editor, 
            ask, 
            noauto 
        }) => {
            commands::handle_now(
                entry, 
                note, 
                back, 
                section, 
                finish_last, 
                from, 
                editor, 
                ask, 
                noauto
            )?;
        }
        Some(Commands::Last) => {
            commands::handle_last()?;
        }
        Some(Commands::Recent { count, section }) => {
            commands::handle_recent(count, section)?;
        }
        Some(Commands::Today { section }) => {
            commands::handle_today(section)?;
        }
        Some(Commands::Tui) => {
            let terminal = ratatui::init();
            let result = App::new().run(terminal);
            ratatui::restore();
            result?;
        }
        Some(Commands::Done {
            entry,
            note,
            ask,
            back,
            at,
            took,
            from,
            section,
            editor,
            archive,
            remove,
            unfinished,
            date,
            noauto,
        }) => {
            commands::handle_done(
                entry,
                note,
                ask,
                back,
                at,
                took,
                from,
                section,
                editor,
                archive,
                remove,
                unfinished,
                date,
                noauto,
            )?;
        }
        Some(Commands::Finish {
            count,
            archive,
            at,
            auto,
            back,
            from,
            interactive,
            not,
            remove,
            sections,
            search,
            took,
            tag,
            unfinished,
            update,
            exact,
            date,
        }) => {
            commands::handle_finish(
                count,
                archive,
                at,
                auto,
                back,
                from,
                interactive,
                not,
                remove,
                sections,
                search,
                took,
                tag,
                unfinished,
                update,
                exact,
                date,
            )?;
        }
        Some(Commands::Did {
            entry,
            note,
            ask,
            back,
            at,
            took,
            from,
            section,
            editor,
            archive,
            remove,
            unfinished,
            date,
            noauto,
        }) => {
            // Did is an alias for done
            commands::handle_done(
                entry,
                note,
                ask,
                back,
                at,
                took,
                from,
                section,
                editor,
                archive,
                remove,
                unfinished,
                date,
                noauto,
            )?;
        }
        Some(Commands::Cancel {
            count,
            archive,
            interactive,
            not,
            sections,
            search,
            tag,
            unfinished,
            exact,
        }) => {
            commands::handle_cancel(
                count,
                archive,
                interactive,
                not,
                sections,
                search,
                tag,
                unfinished,
                exact,
            )?;
        }
        Some(Commands::Delete {
            count,
            interactive,
            not,
            sections,
            search,
            tag,
            exact,
            force,
        }) => {
            commands::handle_delete(
                count,
                interactive,
                not,
                sections,
                search,
                tag,
                exact,
                force,
            )?;
        }
        Some(Commands::Again {
            noauto,
            ask,
            back,
            bool_op,
            case,
            editor,
            interactive,
            in_section,
            note,
            not,
            sections,
            search,
            tag,
            val,
            exact,
        }) => {
            commands::handle_again(
                noauto,
                ask,
                back,
                bool_op,
                case,
                editor,
                interactive,
                in_section,
                note,
                not,
                sections,
                search,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Tag {
            tags,
            autotag,
            bool_op,
            count,
            case,
            date,
            force,
            interactive,
            not,
            remove,
            regex,
            rename,
            sections,
            search,
            tag,
            unfinished,
            value,
            val,
            exact,
        }) => {
            commands::handle_tag(
                tags,
                autotag,
                bool_op,
                count,
                case,
                date,
                force,
                interactive,
                not,
                remove,
                regex,
                rename,
                sections,
                search,
                tag,
                unfinished,
                value,
                val,
                exact,
            )?;
        }
        Some(Commands::Note {
            note,
            ask,
            bool_op,
            case,
            editor,
            interactive,
            not,
            remove,
            sections,
            search,
            tag,
            val,
            exact,
        }) => {
            commands::handle_note(
                note,
                ask,
                bool_op,
                case,
                editor,
                interactive,
                not,
                remove,
                sections,
                search,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Resume {
            noauto,
            ask,
            back,
            bool_op,
            case,
            editor,
            interactive,
            in_section,
            note,
            not,
            sections,
            search,
            tag,
            val,
            exact,
        }) => {
            // Resume is an alias for again
            commands::handle_again(
                noauto,
                ask,
                back,
                bool_op,
                case,
                editor,
                interactive,
                in_section,
                note,
                not,
                sections,
                search,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Mark {
            bool_op,
            count,
            case,
            date,
            force,
            interactive,
            not,
            remove,
            sections,
            search,
            tag,
            unfinished,
            val,
            exact,
        }) => {
            commands::handle_mark(
                bool_op,
                count,
                case,
                date,
                force,
                interactive,
                not,
                remove,
                sections,
                search,
                tag,
                unfinished,
                val,
                exact,
            )?;
        }
        Some(Commands::Flag {
            bool_op,
            count,
            case,
            date,
            force,
            interactive,
            not,
            remove,
            sections,
            search,
            tag,
            unfinished,
            val,
            exact,
        }) => {
            // Flag is an alias for mark
            commands::handle_mark(
                bool_op,
                count,
                case,
                date,
                force,
                interactive,
                not,
                remove,
                sections,
                search,
                tag,
                unfinished,
                val,
                exact,
            )?;
        }
        Some(Commands::Reset {
            date_string,
            bool_op,
            case,
            from,
            interactive,
            no_resume,
            not,
            resume,
            sections,
            search,
            took,
            tag,
            val,
            exact,
        }) => {
            commands::handle_reset(
                date_string,
                bool_op,
                case,
                from,
                interactive,
                no_resume,
                not,
                resume,
                sections,
                search,
                took,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Begin {
            date_string,
            bool_op,
            case,
            from,
            interactive,
            no_resume,
            not,
            resume,
            sections,
            search,
            took,
            tag,
            val,
            exact,
        }) => {
            // Begin is an alias for reset
            commands::handle_reset(
                date_string,
                bool_op,
                case,
                from,
                interactive,
                no_resume,
                not,
                resume,
                sections,
                search,
                took,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Show {
            args,
            age,
            after,
            before,
            bool_op,
            count,
            case,
            config_template,
            duration,
            editor,
            from,
            hilite,
            interactive,
            menu,
            not,
            output,
            only_timed,
            sections,
            save,
            search,
            sort,
            times,
            tag,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
            val,
            exact,
        }) => {
            commands::handle_show(
                args,
                age,
                after,
                before,
                bool_op,
                count,
                case,
                config_template,
                duration,
                editor,
                from,
                hilite,
                interactive,
                menu,
                not,
                output,
                only_timed,
                sections,
                save,
                search,
                sort,
                times,
                tag,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
                val,
                exact,
            )?;
        }
        Some(Commands::Grep {
            pattern,
            after,
            before,
            bool_op,
            case,
            config_template,
            delete,
            duration,
            editor,
            from,
            hilite,
            interactive,
            not,
            output,
            only_timed,
            sections,
            save,
            times,
            tag,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
            val,
            exact,
        }) => {
            commands::handle_grep(
                pattern,
                after,
                before,
                bool_op,
                case,
                config_template,
                delete,
                duration,
                editor,
                from,
                hilite,
                interactive,
                not,
                output,
                only_timed,
                sections,
                save,
                times,
                tag,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
                val,
                exact,
            )?;
        }
        Some(Commands::Search {
            pattern,
            after,
            before,
            bool_op,
            case,
            config_template,
            delete,
            duration,
            editor,
            from,
            hilite,
            interactive,
            not,
            output,
            only_timed,
            sections,
            save,
            times,
            tag,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
            val,
            exact,
        }) => {
            // Search is an alias for grep
            commands::handle_grep(
                pattern,
                after,
                before,
                bool_op,
                case,
                config_template,
                delete,
                duration,
                editor,
                from,
                hilite,
                interactive,
                not,
                output,
                only_timed,
                sections,
                save,
                times,
                tag,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
                val,
                exact,
            )?;
        }
        Some(Commands::On {
            date_string,
            after,
            before,
            bool_op,
            case,
            config_template,
            duration,
            from,
            not,
            output,
            only_timed,
            sections,
            save,
            search,
            times,
            tag,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
            val,
            exact,
        }) => {
            commands::handle_on(
                date_string,
                after,
                before,
                bool_op,
                case,
                config_template,
                duration,
                from,
                not,
                output,
                only_timed,
                sections,
                save,
                search,
                times,
                tag,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
                val,
                exact,
            )?;
        }
        Some(Commands::Since {
            date_string,
            bool_op,
            case,
            config_template,
            duration,
            not,
            output,
            only_timed,
            sections,
            save,
            search,
            times,
            tag,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
            val,
            exact,
        }) => {
            commands::handle_since(
                date_string,
                bool_op,
                case,
                config_template,
                duration,
                not,
                output,
                only_timed,
                sections,
                save,
                search,
                times,
                tag,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
                val,
                exact,
            )?;
        }
        Some(Commands::Yesterday {
            after,
            before,
            config_template,
            duration,
            from,
            output,
            only_timed,
            sections,
            save,
            times,
            tag_order,
            tag_sort,
            template,
            title,
            totals,
        }) => {
            commands::handle_yesterday(
                after,
                before,
                config_template,
                duration,
                from,
                output,
                only_timed,
                sections,
                save,
                times,
                tag_order,
                tag_sort,
                template,
                title,
                totals,
            )?;
        }
        Some(Commands::Sections { action }) => {
            commands::handle_sections(action)?;
        }
        Some(Commands::Archive {
            target,
            after,
            before,
            bool_op,
            case,
            from,
            keep,
            label,
            not,
            search,
            to,
            tag,
            val,
            exact,
        }) => {
            commands::handle_archive(
                target,
                after,
                before,
                bool_op,
                case,
                from,
                keep,
                label,
                not,
                search,
                to,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Rotate {
            before,
            bool_op,
            case,
            keep,
            not,
            section,
            search,
            tag,
            val,
            exact,
        }) => {
            commands::handle_rotate(
                before,
                bool_op,
                case,
                keep,
                not,
                section,
                search,
                tag,
                val,
                exact,
            )?;
        }
        Some(Commands::Tags {
            max_count,
            bool_op,
            counts,
            case,
            interactive,
            line,
            not,
            order,
            section,
            search,
            sort,
            tag,
            val,
            exact,
        }) => {
            commands::handle_tags(
                max_count,
                bool_op,
                counts,
                case,
                interactive,
                line,
                not,
                order,
                section,
                search,
                sort,
                tag,
                val,
                exact,
            )?;
        }
        None => {
            // If no command but task words provided, treat as "now" command
            if !cli.task.is_empty() {
                commands::handle_now(
                    cli.task, 
                    None, 
                    None, 
                    None, 
                    false, 
                    None, 
                    false, 
                    false, 
                    false
                )?;
            } else {
                // If no command and no task words, show recent entries
                commands::handle_recent(10, None)?;
            }
        }
    }

    Ok(())
}
